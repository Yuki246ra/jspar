---
title: "R講習会-プロットコース"
author: "written by jspar project"
date: "`r paste('last update:', Sys.Date())`"
tutorial: 
  id: "researchwithr.ga/ggplot2"
  version: 0.1
lang: ja
output: 
  learnr::tutorial:
    includes: 
      in_header: ../header.html
      before_body: ../gnavi.html
    progressive: false
    number_sections: false
    language:
      en:
        text:
          startover: リセットする
        button:
          runcode: コードを実行
          continue: 続ける
          copyclipboard: クリップボードにコピー
          startover: リセットする
          previoustopic: 前のトピック
          nexttopic: 次のトピック
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(tidyverse)
#library(magrittr)

knitr::opts_chunk$set(error = TRUE)

tutorial_options(exercise.timelimit = 10)

## start-over-automatically-at-everyaccess
options(tutorial.storage = list(
  # save an arbitrary R object "data" to storage
  save_object = function(tutorial_id, tutorial_version, user_id, object_id, data) {},
  # retreive a single R object from storage
  get_object = function(tutorial_id, tutorial_version, user_id, object_id) {NULL},
  # retreive a list of all R objects stored
  get_objects = function(tutorial_id, tutorial_version, user_id) {list()},
  # remove all stored R objects
  remove_all_objects = function(tutorial_id, tutorial_version, user_id) {}
))

#data_q <- read_csv("../r-basics/data/data_questionnaire.csv", show_col_types = F)
data_p <- read_csv("../r-basics/data/data_phyis.csv", show_col_types = F)

data_iris <- iris %>% 
  as_tibble()

#setwd("data")
```

## 準備

**このセクションのゴール**

1.  今回使うパッケージを読み込むことができる。
2.  `data_p`をプロット用にロングデータに変換できる。
3.  ggplot2のキャンバスを用意できる。

### パッケージの読み込み

`tidyverse`パッケージを読み込むと、今回使う`ggplot2`も併せて読み込まれます。

```{r prep, exercise=TRUE}
library(tidyverse)

```

### データの準備

ggplotでは、１行が１観測で１列が１変数という整然データ（ロングデータ）のデータを用意する必要があります。

今回は、`iris`というRに内蔵されているサンプルデータを使ってみます。

```{r prep_data, exercise=TRUE}
data_iris <- iris %>% 
  as_tibble() %>% 
  mutate(., id = 1:nrow(.)) %>% 
  relocate(id)

data_iris #構造を確認しておく

```

#### ワイドデータのロングデータへの変換

`iris`は元から整然データなので問題ありませんが、サンプルで用意している`data_p`はワイドデータ（condition1\~3が横並び）なので、データを少し変形する必要があります。

`pivot_longer()`を使うと、ワイドデータをロングデータに変換できます。

-   `cols`で縦につなげたい列を一括で指定します。ここでは列名がconditionで始まる(starts_with)列を一括で指定しました。

-   `names_to`で、縦につなげた列の列名を使って、conditionsという新しい列を作成するように指示しています。これがないと、縦につなげた後にどのデータがどの条件のものなのかわからなくなります。

-   `values_to`で、condition1\~3の列にあった観測値を縦に一つにまとめた列の、新しい列名(values)を指定しています。

```{r to_long, exercise=TRUE}
data_p_long <- pivot_longer(data = data_p, #元データ
                            cols = starts_with("condition"), #ロングデータにしたい列
                            names_to = "conditions", #新しく作る条件を示す列の列名
                            values_to = "values" #新しく作る観測値列の列名
                            ) 

data_p_long
```

コンソールに各データの変数名を入力して実行し、データの概要を把握しておいてください。また`data_p`と、`data_p_long`の違いを見てみてください。

```{r conf_data, exercise=TRUE, exercise.setup = "to_long"}
data_iris %>% 
  summary()

data_p

data_p_long
```

18行7列だった`data_p`が、54(=18人\*3条件）行6列となりました。`id`や`group`,`sex`そして`age`列が1,1,1,2,2,2,3,3,3のように、必要な数だけ自動的に複製されています。`pivot_longer()`の`cols`で指定しなかった列はすべて、自動的に複製されます。

### キャンバスの準備

`ggplot2`を使ったプロットは、キャンバスを準備するところから始まります。キャンバスには、プロットに使うデータや、縦軸横軸に使う列名など、プロット全体に影響を及ぼす設定を盛り込みます。

ほとんどの場面では、以下のような設定をします。

-   data （第1引数） でプロットに使うデータを指定

-   mapping = aes()で、x軸とy軸に使う列名を指定

```{r prep_canvas, exercise=TRUE, exercise.setup="conf_data"}
canvas_iris <- ggplot(data = data_iris, mapping = aes(x = Petal.Width, y = Sepal.Length))

canvas_p <- ggplot(data = data_p_long, mapping = aes(x = conditions, y = values))

```

キャンバスだけで一度プロットしてみましょう。

コンソールに`plot(キャンバスを入れた変数)`と入れてEnterか、ただ単に`変数名`を入力してEnterすると、現時点のキャンバスがプロットされます。

```{r check_canvas, exercise=TRUE, exercise.setup = "prep_canvas"}

plot(canvas_iris)

canvas_p

```

## プロット基礎１（散布図）

**このセクションのゴール**

1.  ggpot2を使って、散布図を描くことができる
2.  散布図の各ポイントをirisのSpeciesごとに色分けできる
3.  散布図の各ポイントをirisのSpeciesごとに形分けできる
4.  散布図の各ポイントを半透明にできる

### とりあえず散布図を描いてみる

散布図は、先に用意したキャンバスに`geom_point()`を足すことで描画できます。

キャンバスを作るときにx軸に`Petal.Width`, y軸に`Sepal.Length`を設定したので、その設定が利用されます。

```{r scatter1, exercise = TRUE, exercise.setup = "prep_canvas"}

scatter_iris <- canvas_iris + geom_point()

```

`scatter_iris`とコンソールに入力して、プロット結果を見てみましょう。

```{r scatter2, exercise = TRUE, exercise.setup = "scatter1"}
scatter_i
```

### グラフの色分け

`ggplot2`では、様々な条件でグラフの見た目を変えることができます。まずは色分けをやってみましょう。

キャンバスを作るときの`aes(colour = 列名)`で、色分けに使う列を指定します。

```{r scatter_colour1, exercise = TRUE, exercise.setup = "scatter1"}

canvas_iris <- ggplot(data = data_iris, 
                      mapping = aes(x = Petal.Width, 
                                    y = Sepal.Length, 
                                    color = Species)) # <- ここ！

scatter_iris <- 
  canvas_iris + 
  geom_point() #散布図を指定

scatter_iris

```

凡例も自動で追加されます。

実はここで描画したプロットには、同じ点に複数のデータが存在している箇所があります。そこで、各点の透明度を50%に設定して、再度実行してみましょう。透明度は`geom_point(alpha = 0.5)`のように小数で指定します。

```{r scatter_colour2, exercise = TRUE, exercise.setup = "scatter_colour1"}

scatter_iris <- 
  canvas_iris +
  geom_point(alpha = 0.5)


scatter_iris
```

色が濃くなっている部分がポイントが重なった部分だとわかります。

## プロット基礎2（ボックスプロット・バイオリンプロット）

正規分布していないデータのプロットなどに便利なボックスプロットやバイオリンプロットも、`geom_boxplot()`や`geom_violin()`を使うと簡単に描画できます。

ここでは、SpeciesごとにPetal.Lengthを比較してみましょう。

```{r boxplot1, exercise=TRUE, exercise.setup="prep_canvas"}

boxplot_iris <- 
  #キャンバスを作る
  ggplot(data = data_iris,
                       mapping = aes(x = Species, 
                                     y = Petal.Length,
                                     colour = Species)) +
  #ボックスプロットを追加する
  geom_boxplot()

boxplot_iris

```

`geom_boxplot()`の中身を追加して、見栄えを調整した例がこちらです。

```{r boxplot2, exercise=TRUE, exercise.setup="prep_canvas"}

boxplot_iris <- 
  #キャンバスづくり
  ggplot(data = data_iris,
                       mapping = aes(x = Species, 
                                     y = Petal.Length,
                                     colour = Species)) +
  #ボックスプロット
  geom_boxplot(aes(fill = Species), # Species毎に塗りつぶす
               show.legend = FALSE, #凡例を表示しない
               alpha = 0.5, #塗りつぶしの濃さを薄めに
               width = 0.4) #横幅を少し狭めに
               

boxplot_iris
```

## プロット基礎２（棒グラフ）

#### プロットする値の計算

棒グラフはプロットに使う各数値（e.g., 平均、ばらつきの範囲）を計算して表にしておく必要があります。

先ほど作成したdata_p\_longをconditionごとに集計してみましょう。

まず、condition毎の平均±SDでを算出する例です。

```{r barplot1, exercise=TRUE, exercise.setup = "to_long"}

data_p_barplot <-
  data_p_long %>% 
  group_by(conditions) %>% 
  summarise(mean = mean(values),  #平均を計算
            sd = sd(values),      #sdを計算
            ymax = mean + sd,     #上側の誤差範囲
            ymin = mean - sd)     #下側の誤差範囲

#コンソールで確認
data_p_bar
```

Conditionごとのmean, sd, ymax, yminを計算できました。これを使ってプロットしていきます。

#### 棒グラフ `geom_col()`の追加

ggplot()で作ったキャンバスに`geom_col()`で棒グラフを追加しました。

```{r barplot2, exercise=TRUE, exercise.setup = "barplot1"}
barplot_data_p <-
  #キャンバスを作る
  ggplot(data = data_p_barplot,
         mapping = aes(x = conditions, y = mean)) + 
  #棒グラフをキャンバスに追加する
  geom_col(mapping = aes(colour = conditions, #外枠の色
                         fill = conditions))  #塗りつぶしの色
 
barplot_data_p

```

続いて、誤差範囲を追加しましょう。後から追加した要素がプロットの最前面に追加されます。

```{r barplot3, exercise=TRUE, exercise.setup = "barplot1"}
barplot_data_p <-
  #キャンバスを作る
  ggplot(data = data_p_barplot,
         mapping = aes(x = conditions, y = mean)) + 
  #棒グラフをキャンバスに追加する
  geom_col(mapping = aes(colour = conditions, #外枠の色
                         fill = conditions)) +  #塗りつぶしの色
  geom_errorbar(mapping = aes(ymin = ymin, ymax = ymax)) #誤差範囲を指定する

barplot_data_p
```

最後に、棒グラフや誤差範囲の横幅を調整、縦軸の軸名や範囲の修正をしたのがこちらです。

```{r barplot4, exercise=TRUE, exercise.setup = "barplot1"}
barplot_data_p <-
  #キャンバスの準備
  ggplot(data = data_p_barplot, mapping = aes(x = conditions, y = mean)) +
  #棒グラフの追加
  geom_col(mapping = aes(colour = conditions, #外枠の色
                         fill = conditions), #塗りつぶしの色
           width = 0.6, #棒グラフの横幅を指定する
           show.legend = FALSE) + #凡例を表示しない
  #誤差範囲の追加
  geom_errorbar(mapping = aes(ymin = ymin, ymax = ymax),#誤差範囲を指定する
                width = 0.2, #キャップの横幅を指定する
                linewidth = 0.3, #エラーバーの線の太さを指定する
                show.legend = FALSE) + #凡例を表示しない
  #ラベルの変更
  labs(title = "Average and SD",
       y = "value (a.u.)") #y軸ラベルを変更する
#プロット
barplot_data_p
```

## プロット基礎４（折れ線グラフ）

### ゴール書いてないね

折れ線グラフもエラーバーを付けるときには先に値を計算しておいた方が便利です'。

#### データの準備

今回は、sexとconditions別のプロットに挑戦してみましょう。

```{r lineplot1, exercise=TRUE, exercise.setup = "to_long"}

data_p_lineplot <- 
  data_p_long %>% 
  group_by(sex, conditions) %>% #複数の条件でグルーピングできます
  summarise(mean = mean(values), 
            sd = sd(values),
            ymin = mean - sd,
            ymax = mean + sd,
            .groups = "drop") #グルーピングを解除

data_p_lineplot

```

`group_by()`に複数の条件を指定したので、表の行数が増えました。

#### 折れ線グラフの描画

では、さっそくキャンバスを用意して、`geom_line()`で折れ線グラフを追加しましょう。

`ggplot()`でキャンバスを用意するときに、`aes()`でgroup = sexと設定すると、sex毎に線を分けることができます。ここでは、さらに線種も性別で変えるように設定しました。

```{r lineplot2, exercise = TRUE, exercise.setup = "lineplot1"}
lineplot_data_p <- 
  ggplot(data_p_lineplot,
         aes(x = conditions, 
             y = mean, 
             group = sex, 
             linetype = sex)) +
  geom_line()

lineplot_data_p

```

続いて、誤差範囲もつけていきます。

```{r lineplot3, exercise = TRUE, exercise.setup = "lineplot1"}
lineplot_data_p <- 
  ggplot(data_p_lineplot,
         aes(x = conditions, 
             y = mean, 
             group = sex,
             linetype = sex)) +
  geom_line() +
  geom_errorbar(aes(ymin = ymin, ymax = ymax),
                width = 0.2)

lineplot_data_p
```

#### 線グラフの重なりを調整する

エクセルで線グラフを作ると、今できた図のようにすべての線が同じ位置にプロットされてしまい、誤差範囲が分かりにくいといったことが頻繁に生じます。そこで、線毎（今回なら性別毎）に少しだけX座標をずらすことで、より分かりやすい図を描くことができます。

ggplotで描画位置をずらすには、`position = position_dodge(width)`という引数を各`geom_xxx()`に設定します。

```{r lineplot4, exercise = TRUE, exercise.setup = "lineplot1"}

dodge_width <- 0.2 #あとでまとめて変更できるようにずらす量を変数に保存する

lineplot_data_p <- 
  ggplot(data_p_lineplot,
         aes(x = conditions, 
             y = mean, 
             group = sex,
             linetype = sex)) +
  geom_line(position = position_dodge(width = dodge_width)) + # ここ！
  geom_errorbar(aes(ymin = ymin, ymax = ymax),
                width = 0.2,
                position = position_dodge(width = dodge_width)) # ここ！

lineplot_data_p


```

平均値のポイントを追加し、線種ではなく色で性別を現した例がこちらです。

また、後に追加した`geom_xxx()`は図上でより前面に配置されるため、折れ線グラフ(`geom_line()`)を最後に追加しています。

```{r lineplot5, exercise = TRUE, exercise.setup = "lineplot1"}

dodge_width <- 0.2 #あとでまとめて変更できるようにずらす量を変数に保存する

lineplot_data_p <- 
  #キャンバスの準備
  ggplot(data_p_lineplot,
         aes(x = conditions, 
             y = mean, 
             group = sex,
             colour = sex)) +
  #エラーバー
  geom_errorbar(aes(ymin = ymin, ymax = ymax),
                width = 0.2,
                position = position_dodge(width = dodge_width)) +
  #ポイントを追加
  geom_point(position = position_dodge(width = dodge_width)) +
  #折れ線グラフ
  geom_line(position = position_dodge(width = dodge_width)) +
  #ラベルを編集
  labs(y = "value (a.u.)")

lineplot_data_p

```

## プロット調整

## プロット結合

## プロットの保存

## 

```{r ggplot2_1, exercise=TRUE}

ggplot(data_iris)

```
